# .github/workflows/build.yml
name: Build & Smoke Test

on:
  push:
    branches:
      - 'develop'
      - 'hotfix'
      - 'feat/**'
  pull_request:
    branches:
      - 'develop'
      - 'hotfix'
      - 'feat/**'
      -
jobs:
  build:
    runs-on: ubuntu-latest

    env:
      JWT_KEY: ${{ secrets.JWT_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      REGION: ${{ secrets.REGION }}
      TZ: ${{ secrets.TZ }}

      BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
      KYONGSUL_BUCKET_NAME: ${{ secrets.KYONGSUL_BUCKET_NAME }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}

      AWS_REGION: ${{ secrets.AWS_REGION }}
      REST_API_KEY: ${{ secrets.REST_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build without tests
        run: ./gradlew clean build -x test --no-daemon

      - name: Run Spring Boot (test profile)
        run: nohup java -jar build/libs/*.jar --spring.profiles.active=test > app.log 2>&1 &

      - name: Wait for server to start
        run: |
          for i in {1..30}; do
            if grep -q "Started" app.log; then
              echo "✅ Spring Boot started"
              exit 0
            fi
            echo "⏳ Waiting for Spring Boot to start..."
            sleep 5
          done
          echo "❌ Server failed to start in time"
          cat app.log
          exit 1

      - name: Smoke test API
        run: |
          curl -f http://localhost:8080/actuator/health